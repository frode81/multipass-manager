<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multipass Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --danger-color: #dc2626;
            --success-color: #16a34a;
            --warning-color: #ca8a04;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --instance-card-background: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .navbar {
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1rem;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo i {
            font-size: 1.5rem;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .card {
            background-color: var(--card-background);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .form-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-control {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #a16207;
        }

        .instance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .instance-card {
            background-color: var(--instance-card-background);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .instance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .instance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .instance-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-running {
            background-color: rgba(22, 163, 74, 0.1);
            color: var(--success-color);
        }

        .status-stopped {
            background-color: rgba(220, 38, 38, 0.1);
            color: var(--danger-color);
        }

        .status-running i {
            color: var(--success-color);
        }

        .status-stopped i {
            color: var(--danger-color);
        }

        .instance-info {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .instance-info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem;
        }

        .instance-info-item span:first-child {
            display: flex;
            align-items: center;
        }

        .instance-info-item span:last-child {
            text-align: right;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .instance-info-item i {
            margin-right: 0.25rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .copy-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .copy-button:hover {
            color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.1);
        }

        .copy-button i {
            font-size: 0.875rem;
        }

        .resource-metrics {
            display: flex;
            justify-content: space-between;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
            height: 20px;
        }

        .resource-metric {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: var(--background-color);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            position: relative;
            overflow: hidden;
        }

        .resource-metric i {
            font-size: 0.7rem;
            width: 12px;
            z-index: 1;
        }

        .resource-metric-label {
            z-index: 1;
            margin-right: 0.25rem;
        }

        .resource-metric-value {
            margin-left: auto;
            z-index: 1;
            font-weight: 500;
        }

        .resource-metric-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background-color: currentColor;
            opacity: 0.1;
            transition: width 0.3s ease;
        }

        .resource-metric.cpu {
            color: var(--primary-color);
        }

        .resource-metric.memory {
            color: var(--success-color);
        }

        .resource-metric.disk {
            color: var(--danger-color);
        }

        .resource-metric.stopped {
            color: var(--text-secondary);
        }

        .instance-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .loading-overlay .message {
            color: white;
            font-size: 1.1rem;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            display: none;
            z-index: 2000;
            animation: slideUp 0.3s ease-out;
        }

        .toast-success {
            background-color: var(--success-color);
        }

        .toast-error {
            background-color: var(--danger-color);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .terminal-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
        }

        .terminal-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            background-color: var(--card-background);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--background-color);
            border-bottom: 1px solid var(--border-color);
        }

        .terminal-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .terminal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .terminal-content {
            flex: 1;
            background-color: #1e1e1e;
            padding: 0.5rem;
            overflow: hidden;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        }

        .terminal-content .xterm {
            padding: 0.5rem;
            height: 100%;
        }

        .btn-terminal {
            background-color: var(--text-secondary);
            color: white;
        }

        .btn-terminal:hover {
            background-color: var(--text-primary);
        }

        .navbar-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-secondary {
            background-color: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--text-primary);
        }

        /* Dialog styles */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .dialog {
            background-color: var(--card-background);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .dialog-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .dialog-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
        }

        .dialog-close:hover {
            color: var(--text-primary);
        }

        .dialog-body {
            margin-bottom: 1.5rem;
        }

        .dialog-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .dialog.show {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .instance-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.25rem;
            margin: 0.25rem 0;
            height: 45px;
        }

        .metric-card {
            background-color: var(--background-color);
            border-radius: 0.25rem;
            padding: 0.125rem;
            position: relative;
        }

        .metric-title {
            font-size: 0.6rem;
            color: var(--text-secondary);
            margin-bottom: 0.125rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .chart-container {
            height: 25px;
            position: relative;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem;
        }

        .checkbox-item input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
        }

        .checkbox-item label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .saved-keys-container {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .saved-key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .saved-key-item:last-child {
            border-bottom: none;
        }

        .saved-key-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .saved-key-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .saved-key-value {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .saved-key-actions {
            display: flex;
            gap: 0.5rem;
        }

        .saved-key-actions button {
            padding: 0.25rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .saved-key-actions button:hover {
            color: var(--primary-color);
            background-color: rgba(37, 99, 235, 0.1);
        }

        .saved-key-actions button.delete-btn:hover {
            color: var(--danger-color);
            background-color: rgba(220, 38, 38, 0.1);
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-content">
            <div class="logo">
                <i class="fas fa-cube"></i>
                Multipass Manager
            </div>
            <div class="navbar-actions">
                <button class="btn btn-secondary" onclick="showSSHKeyDialog()">
                    <i class="fas fa-key"></i>
                    SSH Nøkler
                </button>
                <button class="btn btn-secondary" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logg ut
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-server"></i>
                    Instances
                </h2>
                <button class="btn btn-primary" onclick="showCreateDialog()">
                    <i class="fas fa-plus"></i>
                    Opprett Ny Instance
                </button>
            </div>
            <div id="instanceList" class="instance-grid">
                <!-- Instances vil bli lagt til her dynamisk -->
            </div>
        </div>
    </div>

    <div class="loading-overlay">
        <div class="spinner"></div>
        <span class="message">Oppretter instance...</span>
    </div>

    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <div class="terminal-modal" id="terminalModal">
        <div class="terminal-container">
            <div class="terminal-header">
                <span class="terminal-title">
                    <i class="fas fa-terminal"></i>
                    Terminal: <span id="terminalInstanceName"></span>
                </span>
                <button class="terminal-close" onclick="closeTerminal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="terminal-content" id="terminal"></div>
        </div>
    </div>

    <!-- Dialog for å opprette ny instance -->
    <div id="createInstanceDialog" class="dialog-overlay">
        <div class="dialog">
            <div class="dialog-header">
                <h2 class="dialog-title">
                    <i class="fas fa-plus-circle"></i>
                    Opprett Ny Instance
                </h2>
                <button class="dialog-close" onclick="closeCreateDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <form id="createInstanceForm" onsubmit="handleCreateInstance(event)">
                    <div class="form-group">
                        <label for="instanceName">
                            <i class="fas fa-tag"></i>
                            Navn på instance
                        </label>
                        <input type="text" 
                               id="instanceName" 
                               name="instanceName" 
                               class="form-control"
                               required
                               pattern="[a-zA-Z0-9-]+"
                               title="Kun bokstaver, tall og bindestrek er tillatt. Ingen mellomrom."
                               oninput="this.value = this.value.replace(/\s+/g, '-')">
                        <small class="form-text text-muted">Mellomrom vil automatisk bli erstattet med bindestrek (-)</small>
                    </div>
                    <div class="form-group">
                        <label for="instanceType">
                            <i class="fas fa-server"></i>
                            Image
                        </label>
                        <select id="instanceType" name="instanceType" class="form-control" required>
                            <option value="">Laster tilgjengelige images...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cpuCount">
                            <i class="fas fa-microchip"></i>
                            CPU Kjerner
                        </label>
                        <input type="number" 
                               id="cpuCount" 
                               name="cpuCount" 
                               class="form-control"
                               min="1"
                               max="8"
                               value="1"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="memorySize">
                            <i class="fas fa-memory"></i>
                            Minne (GB)
                        </label>
                        <input type="number" 
                               id="memorySize" 
                               name="memorySize" 
                               class="form-control"
                               min="1"
                               max="16"
                               value="1"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="diskSize">
                            <i class="fas fa-hdd"></i>
                            Diskplass (GB)
                        </label>
                        <input type="number" 
                               id="diskSize" 
                               name="diskSize" 
                               class="form-control"
                               min="5"
                               max="100"
                               value="10"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="networkType">
                            <i class="fas fa-network-wired"></i>
                            Nettverkstype
                        </label>
                        <select id="networkType" name="networkType" class="form-control" required onchange="toggleBridgedOptions()">
                            <option value="default">Standard NAT</option>
                            <option value="bridged">Bridged Nettverk</option>
                        </select>
                    </div>
                    <div id="bridgedOptions" style="display: none;">
                        <div class="form-group">
                            <label for="networkInterface">
                                <i class="fas fa-ethernet"></i>
                                Nettverksgrensesnitt
                            </label>
                            <select id="networkInterface" name="networkInterface" class="form-control">
                                <option value="">Laster grensesnitt...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="macAddress">
                                <i class="fas fa-fingerprint"></i>
                                MAC-adresse (valgfritt)
                            </label>
                            <input type="text" 
                                   id="macAddress" 
                                   name="macAddress" 
                                   class="form-control"
                                   pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$"
                                   placeholder="f.eks. 00:11:22:33:44:55"
                                   title="Gyldig MAC-adresse format: xx:xx:xx:xx:xx:xx">
                        </div>
                    </div>
                    <div class="dialog-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateDialog()">
                            <i class="fas fa-times"></i>
                            Avbryt
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Opprett
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dialog for SSH-nøkkeladministrasjon -->
    <div id="sshKeyDialog" class="dialog-overlay">
        <div class="dialog">
            <div class="dialog-header">
                <h2 class="dialog-title">
                    <i class="fas fa-key"></i>
                    Administrer SSH Nøkler
                </h2>
                <button class="dialog-close" onclick="closeSSHKeyDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="dialog-body">
                <!-- Liste over lagrede nøkler -->
                <div class="form-group">
                    <label>
                        <i class="fas fa-key"></i>
                        Lagrede SSH-nøkler
                    </label>
                    <div id="savedKeysContainer" class="saved-keys-container">
                        <!-- Lagrede nøkler vil bli lagt til her dynamisk -->
                    </div>
                </div>

                <!-- Legg til ny nøkkel -->
                <div class="form-group">
                    <label for="sshKeyName">
                        <i class="fas fa-tag"></i>
                        Navn på nøkkel
                    </label>
                    <input type="text" 
                           id="sshKeyName" 
                           class="form-control" 
                           placeholder="F.eks. 'Min Laptop' eller 'Arbeid'">
                </div>
                <div class="form-group">
                    <label for="sshKeyInput">
                        <i class="fas fa-file-code"></i>
                        Lim inn din offentlige SSH-nøkkel
                    </label>
                    <textarea id="sshKeyInput" 
                              class="form-control" 
                              rows="5" 
                              placeholder="Begynner med 'ssh-rsa' eller 'ssh-ed25519'"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <i class="fas fa-server"></i>
                        Velg instances for å legge til nøkkelen
                    </label>
                    <div id="instanceCheckboxes" class="checkbox-group">
                        <!-- Instances vil bli lagt til her dynamisk -->
                    </div>
                </div>
                <div class="dialog-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSSHKeyDialog()">
                        <i class="fas fa-times"></i>
                        Avbryt
                    </button>
                    <button type="button" class="btn btn-primary" onclick="addSSHKey()">
                        <i class="fas fa-plus"></i>
                        Legg til Nøkkel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isLoading = false;
        let currentTerminal = null;
        let currentTerminalSocket = null;
        let inactivityTimeout;
        const TIMEOUT_DURATION = 10 * 60 * 1000; // 10 minutter i millisekunder

        // Funksjon for å tilbakestille timeout
        function resetInactivityTimeout() {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => {
                handleLogout();
                showToast('Du har blitt logget ut på grunn av inaktivitet', 'warning');
            }, TIMEOUT_DURATION);
        }

        // Legg til event listeners for å oppdage brukeraktivitet
        document.addEventListener('mousemove', resetInactivityTimeout);
        document.addEventListener('keypress', resetInactivityTimeout);
        document.addEventListener('click', resetInactivityTimeout);
        document.addEventListener('scroll', resetInactivityTimeout);

        // Start timeout når siden lastes
        resetInactivityTimeout();

        function showLoading(message = 'Laster...') {
            const overlay = document.querySelector('.loading-overlay');
            const messageEl = overlay.querySelector('.message');
            messageEl.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
        }

        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            // Fjern eksisterende toast først
            toast.style.display = 'none';
            
            // Legg til ny toast
            toast.className = 'toast toast-' + type;
            toastMessage.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        async function runCommand(command) {
            try {
                console.log('Sender kommando:', command);
                const response = await fetch('/run-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command })
                });
                
                const result = await response.json();
                console.log('Server respons:', result);
                
                if (!response.ok) {
                    throw new Error(result.error || result.details || 'Ukjent serverfeil');
                }
                
                if (result.status === 'success') {
                    return result.output;
                } else {
                    throw new Error(result.error || 'Ukjent feil');
                }
            } catch (error) {
                console.error('Detaljert feil ved kjøring av kommando:', {
                    command,
                    error: error.message,
                    stack: error.stack
                });
                throw error;
            }
        }

        async function fetchAvailableImages() {
            try {
                const select = document.getElementById('instanceType');
                select.innerHTML = `
                    <option value="24.04">Ubuntu 24.04 LTS</option>
                    <option value="23.10">Ubuntu 23.10</option>
                    <option value="22.04">Ubuntu 22.04 LTS</option>
                    <option value="20.04">Ubuntu 20.04 LTS</option>
                `;
            } catch (error) {
                console.error('Detaljert feil ved henting av images:', error);
                showToast('Kunne ikke hente tilgjengelige images', 'error');
            }
        }

        async function fetchNetworkInterfaces() {
            try {
                const response = await fetch('/network-interfaces');
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const interfaces = await response.json();
                
                const select = document.getElementById('networkInterface');
                if (!select) return; // Sjekk om elementet fortsatt eksisterer
                
                if (interfaces && Array.isArray(interfaces)) {
                    select.innerHTML = interfaces.map(iface => 
                        `<option value="${iface}">${iface}</option>`
                    ).join('');
                    
                    if (interfaces.length === 0) {
                        select.innerHTML = '<option value="">Ingen tilgjengelige grensesnitt</option>';
                    }
                } else {
                    throw new Error('Ugyldig respons format');
                }
            } catch (error) {
                console.error('Feil ved henting av nettverksgrensesnitt:', error);
                const select = document.getElementById('networkInterface');
                if (select) {
                    select.innerHTML = '<option value="">Kunne ikke hente grensesnitt</option>';
                }
                showToast('Kunne ikke hente nettverksgrensesnitt', 'error');
            }
        }

        function showCreateDialog() {
            const dialog = document.getElementById('createInstanceDialog');
            dialog.style.display = 'flex';
            dialog.querySelector('.dialog').classList.add('show');
            fetchAvailableImages();
            fetchNetworkInterfaces(); // Hent tilgjengelige nettverksgrensesnitt
        }

        async function handleCreateInstance(event) {
            event.preventDefault();
            
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            
            const name = form.instanceName.value;
            const image = form.instanceType.value;
            const cpuCount = form.cpuCount.value;
            const memorySize = form.memorySize.value;
            const diskSize = form.diskSize.value;
            const networkType = form.networkType.value;
            
            let command = `multipass launch ${image} --name ${name} --cpus ${cpuCount} --memory ${memorySize}G --disk ${diskSize}G`;
            
            if (networkType === 'bridged') {
                const networkInterface = form.networkInterface.value;
                const macAddress = form.macAddress.value;
                
                command += ` --network ${networkInterface}`;
                if (macAddress) {
                    command += `,mac=${macAddress}`;
                }
            }
            
            closeCreateDialog();
            showLoading('Sender kommando...');
            
            try {
                console.log('Kjører kommando:', command);
                
                const sendCommandPromise = fetch('/run-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command })
                });

                setTimeout(() => {
                    hideLoading();
                    showToast('Kommando sendt - instance opprettes i bakgrunnen', 'success');
                }, 5000);
                
                const response = await sendCommandPromise;
                const result = await response.json();
                console.log('Resultat:', result);
                
                if (result.status === 'success') {
                    form.reset();
                    fetchInstances();
                    setTimeout(fetchInstances, 5000);
                    setTimeout(fetchInstances, 15000);
                } else {
                    showToast(result.error || 'Kunne ikke opprette instance', 'error');
                }
            } catch (error) {
                console.error('Feil ved opprettelse av instance:', error);
                showToast('En feil oppstod ved opprettelse av instance', 'error');
            } finally {
                submitButton.disabled = false;
            }
        }

        async function deleteInstance(name) {
            if (!confirm(`Er du sikker på at du vil slette "${name}"?`)) return;
            
            showLoading('Sletter instance...');
            document.querySelector('.loading-overlay .message').textContent = 'Sletter instance...';
            
            try {
                await runCommand(`multipass delete ${name} --purge`);
                showToast(`Instance "${name}" er slettet`, 'success');
                await fetchInstances();
            } catch (error) {
                showToast(`Feil ved sletting av "${name}": ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function startInstance(name) {
            showLoading('Starter instance...');
            document.querySelector('.loading-overlay .message').textContent = 'Starter instance...';
            
            try {
                await runCommand(`multipass start ${name}`);
                showToast(`Instance "${name}" er startet`, 'success');
                await fetchInstances();
            } catch (error) {
                showToast(`Feil ved starting av "${name}": ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function stopInstance(name) {
            showLoading('Stopper instance...');
            document.querySelector('.loading-overlay .message').textContent = 'Stopper instance...';
            
            try {
                await runCommand(`multipass stop ${name}`);
                showToast(`Instance "${name}" er stoppet`, 'success');
                await fetchInstances();
            } catch (error) {
                showToast(`Feil ved stopping av "${name}": ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function purgeAll() {
            if (!confirm('Er du sikker på at du vil slette alle instances?')) return;
            
            showLoading('Sletter alle instances...');
            document.querySelector('.loading-overlay .message').textContent = 'Sletter alle instances...';
            
            try {
                await runCommand('multipass stop --all');
                await runCommand('multipass delete --all');
                await runCommand('multipass purge');
                showToast('Alle instances er slettet', 'success');
                await fetchInstances();
            } catch (error) {
                showToast('Feil ved sletting av instances: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function initializeTerminal() {
            const terminal = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                theme: {
                    background: '#1e1e1e',
                    foreground: '#d4d4d4',
                    black: '#1e1e1e',
                    brightBlack: '#666666',
                    red: '#e06c75',
                    brightRed: '#e06c75',
                    green: '#98c379',
                    brightGreen: '#98c379',
                    yellow: '#d19a66',
                    brightYellow: '#d19a66',
                    blue: '#61afef',
                    brightBlue: '#61afef',
                    magenta: '#c678dd',
                    brightMagenta: '#c678dd',
                    cyan: '#56b6c2',
                    brightCyan: '#56b6c2',
                    white: '#d4d4d4',
                    brightWhite: '#d4d4d4',
                    selection: '#264f78',
                    cursor: '#d4d4d4'
                },
                allowTransparency: true,
                scrollback: 10000,
                convertEol: true,
                cursorStyle: 'block',
                cursorBlink: true,
                bellStyle: 'sound'
            });

            const fitAddon = new FitAddon.FitAddon();
            terminal.loadAddon(fitAddon);
            
            return { terminal, fitAddon };
        }

        async function openTerminal(name) {
            const terminalModal = document.getElementById('terminalModal');
            const terminalContent = document.getElementById('terminal');
            const terminalInstanceName = document.getElementById('terminalInstanceName');
            
            terminalInstanceName.textContent = name;
            terminalModal.style.display = 'block';
            terminalContent.innerHTML = '';

            if (currentTerminal) {
                currentTerminal.dispose();
            }
            
            const { terminal, fitAddon } = initializeTerminal();
            currentTerminal = terminal;
            
            terminal.open(terminalContent);
            fitAddon.fit();

            // Opprett WebSocket-tilkobling
            if (currentTerminalSocket) {
                currentTerminalSocket.close();
            }

            try {
                currentTerminalSocket = new WebSocket(`ws://${window.location.host}`);
                
                currentTerminalSocket.onopen = () => {
                    terminal.write('\x1b[33m⚡ Initialiserer tilkobling til container...\x1b[0m\r\n');
                    currentTerminalSocket.send(JSON.stringify({
                        type: 'start',
                        instance: name
                    }));
                };

                currentTerminalSocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'output') {
                        terminal.write(data.data);
                    } else if (data.type === 'error') {
                        terminal.write('\x1b[31m' + data.data + '\x1b[0m');
                    }
                };

                currentTerminalSocket.onerror = (error) => {
                    terminal.write('\x1b[31mFeil ved WebSocket-tilkobling: ' + error.message + '\x1b[0m\r\n');
                };

                currentTerminalSocket.onclose = () => {
                    terminal.write('\x1b[33mTilkobling lukket\x1b[0m\r\n');
                };

                // Håndter input fra terminal
                terminal.onData(data => {
                    if (currentTerminalSocket && currentTerminalSocket.readyState === WebSocket.OPEN) {
                        currentTerminalSocket.send(JSON.stringify({
                            type: 'input',
                            data: data
                        }));
                    }
                });

                // Håndter endring av terminalstørrelse
                window.addEventListener('resize', () => {
                    fitAddon.fit();
                    if (currentTerminalSocket && currentTerminalSocket.readyState === WebSocket.OPEN) {
                        currentTerminalSocket.send(JSON.stringify({
                            type: 'resize',
                            cols: terminal.cols,
                            rows: terminal.rows
                        }));
                    }
                });

                // Aktiver fokus og fit
                setTimeout(() => {
                    terminal.focus();
                    fitAddon.fit();
                    currentTerminalSocket.send(JSON.stringify({
                        type: 'resize',
                        cols: terminal.cols,
                        rows: terminal.rows
                    }));
                }, 100);

            } catch (error) {
                terminal.write('\x1b[31mFeil ved oppsett av terminal: ' + error.message + '\x1b[0m\r\n');
            }
        }

        function closeTerminal() {
            const terminalModal = document.getElementById('terminalModal');
            terminalModal.style.display = 'none';
            
            if (currentTerminalSocket) {
                currentTerminalSocket.close();
                currentTerminalSocket = null;
            }
            
            if (currentTerminal) {
                currentTerminal.dispose();
                currentTerminal = null;
            }
        }

        async function fetchInstances() {
            try {
                const result = await runCommand('multipass list');
                console.log('Raw multipass list output:', result); // Debug output
                const lines = result.split('\n');
                
                // Fjern header-linjen
                const headerLine = lines.shift();
                console.log('Header:', headerLine); // Debug output
                
                // Grupper linjer som tilhører samme instans
                const instanceGroups = [];
                let currentGroup = [];
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    console.log('Processing line:', line); // Debug output
                    
                    // Hvis linjen starter med mellomrom eller er en fortsettelse
                    if (line.match(/^\s+/)) {
                        if (currentGroup.length > 0) {
                            currentGroup.push(line.trim());
                        }
                    } else {
                        // Ny instans, start ny gruppe
                        if (currentGroup.length > 0) {
                            instanceGroups.push(currentGroup);
                        }
                        currentGroup = [line];
                    }
                }
                if (currentGroup.length > 0) {
                    instanceGroups.push(currentGroup);
                }
                
                console.log('Instance groups:', instanceGroups); // Debug output
                
                // Parse hver gruppe til en instans
                const instances = instanceGroups.map(group => {
                    console.log('Processing group:', group); // Debug output
                    const mainLine = group[0];
                    const parts = mainLine.trim().split(/\s+/);
                    console.log('Main line parts:', parts); // Debug output
                    
                    const name = parts[0];
                    const state = parts[1];
                    let ipv4 = parts[2];
                    const image = parts.slice(3).join(' ');
                    
                    // Samle alle IP-adresser
                    const allIPs = [ipv4];
                    for (let i = 1; i < group.length; i++) {
                        const additionalLine = group[i].trim();
                        console.log('Additional line:', additionalLine); // Debug output
                        
                        // Hvis linjen bare inneholder en IP-adresse
                        if (additionalLine.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)) {
                            allIPs.push(additionalLine);
                        } else {
                            // Ellers prøv å finne IP i den fulle linjen
                            const additionalParts = additionalLine.split(/\s+/);
                            const potentialIP = additionalParts.find(part => 
                                part.match(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/)
                            );
                            if (potentialIP) {
                                allIPs.push(potentialIP);
                            }
                        }
                    }
                    
                    // Filtrer ut '--' og tomme verdier, og join med komma
                    const finalIPs = allIPs.filter(ip => ip && ip !== '--').join(', ');
                    console.log('Final IPs for', name, ':', finalIPs); // Debug output
                    
                    return { 
                        name, 
                        state, 
                        ipv4: finalIPs, 
                        image 
                    };
                });

                // Hent detaljert info for hver kjørende instans
                for (const instance of instances) {
                    if (instance.state.toLowerCase() === 'running') {
                        try {
                            const info = await runCommand(`multipass info ${instance.name}`);
                            console.log('Raw info output:', info); // Debug output
                            
                            // Hent ut all tilgjengelig informasjon
                            const loadMatch = info.match(/Load:\s+([0-9., ]+)/);
                            const diskMatch = info.match(/Disk usage:\s+([^(]+?)(?:\s+out of\s+([^\n]+))?$/m);
                            const memoryMatch = info.match(/Memory usage:\s+(\d+\.\d+\w+)\s+out of\s+(\d+\.\d+\w+)/);
                            const cpuMatch = info.match(/CPU\(s\):\s+(\d+)/);
                            const releaseMatch = info.match(/Release:\s+([^\n]+)/);
                            
                            console.log('Memory match:', memoryMatch); // Debug output
                            
                            instance.load = loadMatch ? loadMatch[1].trim() : 'N/A';
                            instance.diskUsage = diskMatch ? {
                                used: diskMatch[1].trim(),
                                total: diskMatch[2] ? diskMatch[2].trim() : 'N/A'
                            } : { used: 'N/A', total: 'N/A' };
                            instance.memoryUsage = memoryMatch ? {
                                used: memoryMatch[1],
                                total: memoryMatch[2]
                            } : { used: '0B', total: '1GB' };
                            instance.cpuCount = cpuMatch ? cpuMatch[1] : 'N/A';
                            instance.release = releaseMatch ? releaseMatch[1] : 'N/A';
                            
                            console.log('Parsed memory usage:', instance.memoryUsage); // Debug output
                        } catch (error) {
                            console.error(`Kunne ikke hente info for ${instance.name}:`, error);
                            instance.load = 'N/A';
                            instance.diskUsage = { used: 'N/A', total: 'N/A' };
                            instance.memoryUsage = { used: 'N/A', total: 'N/A' };
                            instance.cpuCount = 'N/A';
                            instance.release = 'N/A';
                        }
                    } else {
                        instance.load = 'Stoppet';
                        instance.diskUsage = { used: 'Stoppet', total: 'Stoppet' };
                        instance.memoryUsage = { used: 'Stoppet', total: 'Stoppet' };
                        instance.cpuCount = 'Stoppet';
                        instance.release = 'Stoppet';
                    }
                }

                updateInstanceList(instances);
            } catch (error) {
                console.error('Feil ved henting av instances:', error);
                showToast('Feil ved henting av instances', 'error');
            }
        }

        function updateInstanceList(instances) {
            const container = document.getElementById('instanceList');
            const oldCards = container.children;
            const oldCardsMap = new Map();
            
            // Lagre eksisterende kort
            Array.from(oldCards).forEach(card => {
                const name = card.querySelector('.instance-name').textContent.trim();
                oldCardsMap.set(name, card);
            });
            
            // Oppdater eller legg til nye kort
            instances.forEach(instance => {
                const existingCard = oldCardsMap.get(instance.name);
                const newCard = createInstanceCard(instance);
                
                if (existingCard) {
                    // Oppdater bare hvis innholdet er endret
                    if (existingCard.innerHTML !== newCard.innerHTML) {
                        container.replaceChild(newCard, existingCard);
                    }
                    oldCardsMap.delete(instance.name);
                } else {
                    container.appendChild(newCard);
                }
            });
            
            // Fjern kort for instances som ikke lenger eksisterer
            oldCardsMap.forEach((card) => {
                card.remove();
            });
        }

        function parseMemorySize(sizeStr) {
            if (!sizeStr || sizeStr === 'N/A') return 0;
            
            // Fjern eventuelle parenteser og ekstra mellomrom
            sizeStr = sizeStr.replace(/[()]/g, '').trim();
            
            // Støtt både SI (MB, GB) og binære (MiB, GiB) enheter
            const match = sizeStr.match(/^([\d.]+)\s*([KMGT]i?B)$/i);
            if (!match) {
                console.warn('Kunne ikke parse minnestørrelse:', sizeStr);
                return 0;
            }
            
            const value = parseFloat(match[1]);
            const unit = match[2].toUpperCase();
            
            // Binære multipliers (1024-basert)
            const binaryMultipliers = {
                'B': 1,
                'KIB': 1024,
                'MIB': 1024 * 1024,
                'GIB': 1024 * 1024 * 1024,
                'TIB': 1024 * 1024 * 1024 * 1024
            };
            
            // SI multipliers (1000-basert)
            const siMultipliers = {
                'B': 1,
                'KB': 1000,
                'MB': 1000 * 1000,
                'GB': 1000 * 1000 * 1000,
                'TB': 1000 * 1000 * 1000 * 1000
            };
            
            // Velg riktig multiplier basert på om enheten er binær (inneholder 'I')
            const multipliers = unit.includes('I') ? binaryMultipliers : siMultipliers;
            const bytes = value * (multipliers[unit] || 1);
            
            console.log(`Parsing ${sizeStr}: ${value} ${unit} = ${bytes} bytes`); // Debug output
            return bytes;
        }

        function createInstanceCard(instance) {
            const card = document.createElement('div');
            card.className = 'instance-card';

            // Beregn ressursbruk
            let cpuMetric, memoryMetric, diskMetric;
            
            if (instance.state.toLowerCase() === 'running') {
                const cpuLoad = parseFloat(instance.load.split(' ')[0]);
                cpuMetric = {
                    value: Math.min(cpuLoad * 100, 100),
                    text: `${Math.round(cpuLoad * 100)}%`,
                    class: 'cpu'
                };

                // Konverter minnestørrelser til bytes for sammenligning
                const memUsedBytes = parseMemorySize(instance.memoryUsage.used);
                const memTotalBytes = parseMemorySize(instance.memoryUsage.total);
                const memPercent = (memUsedBytes / memTotalBytes) * 100;
                
                // Formater visningen
                const memUsedGB = (memUsedBytes / (1024 * 1024 * 1024)).toFixed(1);
                const memTotalGB = (memTotalBytes / (1024 * 1024 * 1024)).toFixed(1);
                
                memoryMetric = {
                    value: memPercent,
                    text: `${memUsedGB}/${memTotalGB}GB`,
                    class: 'memory'
                };

                const diskUsed = parseFloat(instance.diskUsage.used);
                const diskTotal = parseFloat(instance.diskUsage.total);
                const diskPercent = (diskUsed / diskTotal) * 100;
                diskMetric = {
                    value: diskPercent,
                    text: `${Math.round(diskPercent)}%`,
                    class: 'disk'
                };
            } else {
                cpuMetric = memoryMetric = diskMetric = {
                    value: 0,
                    text: 'Stoppet',
                    class: 'stopped'
                };
            }

            card.innerHTML = `
                <div class="instance-header">
                    <span class="instance-name">
                        <i class="fas fa-cube"></i>
                        ${instance.name}
                    </span>
                    <span class="status-badge status-${instance.state.toLowerCase()}">
                        <i class="fas fa-circle"></i>
                        ${instance.state}
                    </span>
                </div>
                <div class="instance-info">
                    <div class="instance-info-item">
                        <span>
                            <i class="fas fa-network-wired"></i>
                            IP-adresse
                        </span>
                        <span>
                            ${instance.ipv4 || 'Ikke tilgjengelig'}
                            ${instance.ipv4 ? `
                                <button class="copy-button" onclick="copyToClipboard('${instance.ipv4}', this)" title="Kopier IP-adresse">
                                    <i class="fas fa-copy"></i>
                                </button>
                            ` : ''}
                        </span>
                    </div>
                    <div class="instance-info-item">
                        <span>
                            <i class="fab fa-ubuntu"></i>
                            Ubuntu
                        </span>
                        <span>${instance.release}</span>
                    </div>
                </div>
                <div class="resource-metrics">
                    <div class="resource-metric ${cpuMetric.class}">
                        <i class="fas fa-microchip"></i>
                        <span class="resource-metric-label">CPU</span>
                        <span class="resource-metric-value">${cpuMetric.text}</span>
                        <div class="resource-metric-bar" style="width: ${cpuMetric.value}%"></div>
                    </div>
                    <div class="resource-metric ${memoryMetric.class}">
                        <i class="fas fa-memory"></i>
                        <span class="resource-metric-label">RAM</span>
                        <span class="resource-metric-value">${memoryMetric.text}</span>
                        <div class="resource-metric-bar" style="width: ${memoryMetric.value}%"></div>
                    </div>
                    <div class="resource-metric ${diskMetric.class}">
                        <i class="fas fa-hdd"></i>
                        <span class="resource-metric-label">Disk</span>
                        <span class="resource-metric-value">${diskMetric.text}</span>
                        <div class="resource-metric-bar" style="width: ${diskMetric.value}%"></div>
                    </div>
                </div>
                <div class="instance-actions">
                    <button class="btn btn-sm btn-terminal" onclick="openTerminal('${instance.name}')">
                        <i class="fas fa-terminal"></i>
                        Terminal
                    </button>
                    ${instance.state.toLowerCase() === 'running' ? `
                        <button class="btn btn-sm btn-warning" onclick="stopInstance('${instance.name}')">
                            <i class="fas fa-stop"></i>
                            Stopp
                        </button>
                    ` : `
                        <button class="btn btn-sm btn-primary" onclick="startInstance('${instance.name}')">
                            <i class="fas fa-play"></i>
                            Start
                        </button>
                    `}
                    <button class="btn btn-sm btn-danger" onclick="deleteInstance('${instance.name}')">
                        <i class="fas fa-trash"></i>
                        Slett
                    </button>
                </div>
            `;

            return card;
        }

        async function copyToClipboard(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                
                // Endre ikonet midlertidig for å vise suksess
                const icon = button.querySelector('i');
                icon.className = 'fas fa-check';
                button.style.color = 'var(--success-color)';
                button.style.backgroundColor = 'rgba(22, 163, 74, 0.1)';
                
                // Tilbakestill etter 1.5 sekunder
                setTimeout(() => {
                    icon.className = 'fas fa-copy';
                    button.style.color = '';
                    button.style.backgroundColor = '';
                }, 1500);
                
                showToast('IP-adresse kopiert til utklippstavlen', 'success', 1500);
            } catch (err) {
                showToast('Kunne ikke kopiere IP-adresse', 'error');
            }
        }

        // Last inn instances når siden lastes
        fetchInstances();
        
        // Oppdater instances hvert 10. sekund
        setInterval(fetchInstances, 10000);

        async function handleLogout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    window.location.href = '/login.html';
                }
            } catch (error) {
                showToast('Feil ved utlogging', 'error');
            }
        }

        function closeCreateDialog() {
            const dialog = document.getElementById('createInstanceDialog');
            dialog.style.display = 'none';
            dialog.querySelector('.dialog').classList.remove('show');
        }

        function toggleBridgedOptions() {
            const bridgedOptions = document.getElementById('bridgedOptions');
            bridgedOptions.style.display = document.getElementById('networkType').value === 'bridged' ? 'block' : 'none';
        }

        function showSSHKeyDialog() {
            const dialog = document.getElementById('sshKeyDialog');
            dialog.style.display = 'flex';
            dialog.querySelector('.dialog').classList.add('show');
            updateInstanceCheckboxes();
            updateSavedKeysDisplay();
        }

        function closeSSHKeyDialog() {
            const dialog = document.getElementById('sshKeyDialog');
            dialog.style.display = 'none';
            dialog.querySelector('.dialog').classList.remove('show');
            document.getElementById('sshKeyInput').value = '';
        }

        function updateInstanceCheckboxes() {
            const container = document.getElementById('instanceCheckboxes');
            container.innerHTML = '';

            // Hent alle instances fra instanceList
            const instanceCards = document.querySelectorAll('.instance-card');
            instanceCards.forEach(card => {
                const name = card.querySelector('.instance-name').textContent.trim();
                const state = card.querySelector('.status-badge').textContent.trim();
                const isRunning = state.toLowerCase().includes('running');

                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" 
                           id="instance-${name}" 
                           value="${name}"
                           ${!isRunning ? 'disabled' : ''}>
                    <label for="instance-${name}">
                        <i class="fas fa-cube"></i>
                        ${name}
                        ${!isRunning ? ' (Ikke tilgjengelig - må være kjørende)' : ''}
                    </label>
                `;
                container.appendChild(checkboxItem);
            });
        }

        // Funksjon for å lagre SSH-nøkler i localStorage
        function saveSSHKey(name, key) {
            const savedKeys = getSavedSSHKeys();
            savedKeys[name] = key;
            localStorage.setItem('saved_ssh_keys', JSON.stringify(savedKeys));
        }

        // Funksjon for å hente lagrede SSH-nøkler
        function getSavedSSHKeys() {
            const savedKeys = localStorage.getItem('saved_ssh_keys');
            return savedKeys ? JSON.parse(savedKeys) : {};
        }

        // Funksjon for å slette en SSH-nøkkel
        function deleteSSHKey(name) {
            const savedKeys = getSavedSSHKeys();
            delete savedKeys[name];
            localStorage.setItem('saved_ssh_keys', JSON.stringify(savedKeys));
            updateSavedKeysDisplay();
        }

        // Funksjon for å vise lagrede nøkler
        function updateSavedKeysDisplay() {
            const container = document.getElementById('savedKeysContainer');
            const savedKeys = getSavedSSHKeys();
            
            if (Object.keys(savedKeys).length === 0) {
                container.innerHTML = '<div class="text-secondary" style="padding: 0.5rem;">Ingen lagrede nøkler</div>';
                return;
            }
            
            container.innerHTML = Object.entries(savedKeys).map(([name, key]) => `
                <div class="saved-key-item">
                    <div class="saved-key-info">
                        <div class="saved-key-name">${name}</div>
                        <div class="saved-key-value">${key.substring(0, 50)}...</div>
                    </div>
                    <div class="saved-key-actions">
                        <button onclick="useSSHKey('${name}')" title="Bruk denne nøkkelen">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button onclick="copySSHKey('${name}')" title="Kopier nøkkel">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="delete-btn" onclick="deleteSSHKey('${name}')" title="Slett nøkkel">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Funksjon for å bruke en lagret nøkkel
        function useSSHKey(name) {
            const savedKeys = getSavedSSHKeys();
            const key = savedKeys[name];
            document.getElementById('sshKeyInput').value = key;
        }

        // Funksjon for å kopiere en nøkkel
        async function copySSHKey(name) {
            const savedKeys = getSavedSSHKeys();
            const key = savedKeys[name];
            
            try {
                await navigator.clipboard.writeText(key);
                showToast('SSH-nøkkel kopiert til utklippstavlen', 'success');
            } catch (err) {
                showToast('Kunne ikke kopiere SSH-nøkkel', 'error');
            }
        }

        // Oppdater addSSHKey funksjonen
        async function addSSHKey() {
            const keyName = document.getElementById('sshKeyName').value.trim();
            const sshKey = document.getElementById('sshKeyInput').value.trim();
            
            if (!sshKey) {
                showToast('Vennligst lim inn en SSH-nøkkel', 'error');
                return;
            }

            if (!sshKey.startsWith('ssh-rsa') && !sshKey.startsWith('ssh-ed25519')) {
                showToast('Ugyldig SSH-nøkkel format', 'error');
                return;
            }

            const selectedInstances = Array.from(document.querySelectorAll('#instanceCheckboxes input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            if (selectedInstances.length === 0) {
                showToast('Velg minst én instance', 'error');
                return;
            }

            // Sjekk om nøkkelen allerede eksisterer
            const savedKeys = getSavedSSHKeys();
            const existingKeyName = Object.entries(savedKeys).find(([name, key]) => key === sshKey)?.[0];

            // Hvis nøkkelen ikke finnes fra før og ikke har fått et navn
            if (!existingKeyName && !keyName) {
                showToast('Vennligst gi den nye nøkkelen et navn', 'error');
                return;
            }

            // Lagre nøkkelen kun hvis den er ny
            if (!existingKeyName && keyName) {
                saveSSHKey(keyName, sshKey);
                updateSavedKeysDisplay();
            }

            showLoading('Legger til SSH-nøkkel...');

            try {
                for (const instance of selectedInstances) {
                    // Opprett .ssh-mappen og sett riktige tillatelser
                    await runCommand(`multipass exec ${instance} -- sudo mkdir -p /home/ubuntu/.ssh`);
                    await runCommand(`multipass exec ${instance} -- sudo chown ubuntu:ubuntu /home/ubuntu/.ssh`);
                    await runCommand(`multipass exec ${instance} -- sudo chmod 700 /home/ubuntu/.ssh`);
                    
                    // Legg til SSH-nøkkelen i authorized_keys
                    const escapedKey = sshKey.replace(/'/g, "'\\''"); // Escape single quotes
                    await runCommand(`multipass exec ${instance} -- /bin/bash -c 'echo "${escapedKey}" >> /home/ubuntu/.ssh/authorized_keys'`);
                    
                    // Sett riktige tillatelser på authorized_keys
                    await runCommand(`multipass exec ${instance} -- sudo chown ubuntu:ubuntu /home/ubuntu/.ssh/authorized_keys`);
                    await runCommand(`multipass exec ${instance} -- sudo chmod 600 /home/ubuntu/.ssh/authorized_keys`);
                }

                showToast('SSH-nøkkel lagt til i valgte instances', 'success');
                
                // Reset input fields
                document.getElementById('sshKeyName').value = '';
                document.getElementById('sshKeyInput').value = '';
                
                closeSSHKeyDialog();
            } catch (error) {
                console.error('Feil ved tillegging av SSH-nøkkel:', error);
                showToast('Feil ved tillegging av SSH-nøkkel: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>